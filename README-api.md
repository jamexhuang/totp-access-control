# Home OTP 系統文件

## 系統概述

Home OTP 是一個基於 Cloudflare Workers 開發的門禁管理系統，通過一次性密碼(TOTP)提供安全的門禁驗證機制。系統支持多用戶管理、臨時訪客授權、完整的操作日誌記錄以及管理員權限控制。

### 主要功能

- **一次性密碼(TOTP)驗證**：與 Google Authenticator 等 TOTP 應用兼容
- **多用戶管理**：支持永久用戶和臨時用戶的管理
- **訪問控制**：支持用戶啟用/禁用功能
- **完整日誌記錄**：記錄所有系統活動和門禁訪問
- **管理員系統**：多級管理權限與帳戶管理
- **安全認證**：整合 Turnstile 防機器人攻擊

## 系統架構

系統採用模塊化設計，基於 Cloudflare Workers 無伺服器架構，使用 D1 資料庫存儲用戶數據和操作日誌，KV 存儲用於會話管理和系統配置。

```
home-otp/
├── src/                     # 源代碼目錄
│   ├── index.js             # 系統入口點
│   ├── worker.js            # Worker 主程式
│   ├── config/              # 配置文件目錄
│   │   └── constants.js     # 系統常量配置
│   ├── models/              # 數據模型目錄
│   │   ├── db.js            # 數據庫初始化與管理
│   │   ├── users.js         # 用戶模型操作
│   │   └── admins.js        # 管理員模型操作
│   ├── services/            # 服務層目錄
│   │   ├── authService.js   # 認證相關服務
│   │   ├── logService.js    # 日誌服務
│   │   └── doorService.js   # 門禁控制服務
│   ├── handlers/            # 請求處理器目錄
│   │   └── authHandler.js   # 認證請求處理
│   └── utils/               # 工具函數目錄
│       ├── crypto.js        # 加密相關工具
│       └── otp.js           # OTP 生成與驗證
└── wrangler.toml            # Cloudflare Worker 配置
```

## 核心文件詳細說明

### 入口文件
- **index.js**: 
  - 系統入口點，導出 worker 實例供 Cloudflare 載入
  - 處理環境變數初始化
  - 整合所有模組並啟動應用

- **worker.js**: 
  - Worker 主程式，負責所有 HTTP 請求的路由和處理
  - 集成 Hono 框架進行 API 路由管理
  - 處理靜態資源請求與動態 API 請求
  - 實現全局錯誤處理和請求日誌記錄
  - 設置 CORS 和安全標頭配置

### 配置文件
- **config/constants.js**: 
  - 包含系統關鍵配置常量
  - Turnstile 認證密鑰配置與驗證設置
  - 默認管理員帳戶設置（用戶名、密碼、郵箱）
  - 系統預設用戶配置和規則
  - 會話持續時間和過期設置
  - 系統安全參數配置
  - 開門延遲和冷卻時間設置

### 模型文件
- **models/db.js**: 
  - 資料庫結構初始化與版本管理
  - 表格創建（users, logs, sessions, admins）
  - 資料庫結構遷移和版本兼容性處理
  - 系統啟動時間管理與記錄
  - 表結構更新檢測與自動升級
  - 資料庫連接池管理和優化
  - 系統狀態表維護

- **models/users.js**: 
  - 用戶 CRUD 操作完整實現
  - 默認用戶初始化與檢查
  - 臨時用戶創建與過期管理
  - 永久用戶管理與更新
  - 用戶狀態切換（啟用/禁用）流程
  - 用戶資料驗證與過濾
  - OTP 秘鑰生成與管理
  - 批量用戶操作支持
  - 用戶統計信息查詢
  - 活躍與非活躍用戶篩選

- **models/admins.js**:
  - 管理員帳戶完整生命週期管理
  - 密碼加密（使用 bcrypt）與驗證
  - 管理員信息安全更新機制
  - 管理員角色權限管理
  - 管理員操作限制設置
  - 默認管理員初始化與檢查
  - 管理員狀態管理（啟用/禁用）
  - 管理員登入嘗試記錄
  - 防暴力攻擊機制實現

### 服務文件
- **services/authService.js**:
  - Turnstile 人機驗證完整集成
  - 會話創建、驗證、刪除和續期
  - JWT 令牌生成與驗證
  - 認證中間件實現與權限控制
  - 多因素認證支持
  - 會話活動檢測與自動登出
  - IP 地址檢查與異常登入保護
  - 管理員權限層級檢查
  - 安全標頭管理

- **services/logService.js**:
  - 系統日誌分級記錄機制
  - 用戶活動詳細追蹤
  - 管理員操作審計記錄
  - 安全事件與異常記錄
  - 日誌查詢與過濾功能
  - 日誌分析與統計報表
  - 日誌保留策略管理
  - 實時日誌監控支持
  - 批量日誌操作與匯出
  - 關鍵操作強制日誌記錄

- **services/doorService.js**:
  - 門禁控制完整邏輯實現
  - 開門請求處理與驗證
  - 多門禁設備支持
  - 與物理門禁設備的 API 通訊
  - 開門指令加密與安全傳輸
  - 開門時間限制與頻率控制
  - 緊急模式支持
  - 門禁狀態監控與通知
  - 異常開門嘗試檢測
  - 門禁時間規則管理

### 處理器文件
- **handlers/authHandler.js**:
  - 登錄請求完整處理流程
  - 會話驗證與狀態檢查
  - 登出流程處理與會話清理
  - 認證失敗處理策略
  - 密碼重置處理
  - 多因素認證處理
  - 登入嘗試限制實現
  - 異常登入模式檢測
  - 認證流程完整封裝
  - CSRF 保護實現

### 工具文件
- **utils/crypto.js**:
  - 安全隨機 ID 生成算法
  - 強密鑰生成功能
  - 加密與解密工具函數
  - 雜湊函數實現與工具
  - 數據簽名與驗證
  - 密碼強度檢查工具
  - 加鹽雜湊實現
  - 安全隨機數生成
  - 密碼學常量管理

- **utils/otp.js**:
  - TOTP（基於時間的一次性密碼）演算法完整實現
  - RFC 6238 標準兼容
  - 一次性密碼生成與驗證核心邏輯
  - 時間窗口管理與滾動碼支持
  - 多種雜湊算法支持（SHA1、SHA256）
  - OTP URI 生成（兼容主流認證器應用）
  - QR Code 生成輔助功能
  - OTP 密鑰安全管理
  - 時間偏移處理機制

## API 端點詳細說明

### 認證 API

#### `/auth/login` - 管理員登入
- **方法**: POST
- **請求體**:
  ```json
  {
    "username": "管理員用戶名",
    "password": "管理員密碼",
    "turnstileResponse": "Turnstile回應令牌"
  }
  ```
- **處理流程**:
  1. 驗證請求格式並檢查必填欄位
  2. 驗證 Turnstile 令牌防止機器人攻擊
  3. 在資料庫中查找管理員並驗證密碼
  4. 檢查管理員帳號狀態（是否禁用）
  5. 創建新會話並生成 sessionId
  6. 將會話信息存儲在 KV 中
  7. 設置會話 cookie 並記錄登入日誌
- **成功響應** (200):
  ```json
  {
    "success": true,
    "message": "登入成功",
    "admin": {
      "username": "管理員用戶名",
      "email": "電子郵件地址"
    }
  }
  ```
- **錯誤響應**:
  - 401: 認證失敗（用戶名/密碼錯誤）
  - 403: 帳號已被禁用
  - 400: 請求格式錯誤或 Turnstile 驗證失敗

#### `/auth/check` - 檢查會話狀態
- **方法**: GET
- **請求**: 無需請求體，從 cookie 獲取 sessionId
- **處理流程**:
  1. 從請求 cookie 中獲取 sessionId
  2. 在 KV 存儲中查找對應的會話數據
  3. 驗證會話是否有效及未過期
  4. 更新會話最後活動時間
- **成功響應** (200):
  ```json
  {
    "authenticated": true,
    "admin": {
      "username": "管理員用戶名",
      "email": "電子郵件地址"
    }
  }
  ```
- **錯誤響應**:
  - 401: 未認證或會話已過期
  - 500: 服務器錯誤

#### `/auth/logout` - 登出系統
- **方法**: POST
- **請求**: 無需請求體，從 cookie 獲取 sessionId
- **處理流程**:
  1. 從請求 cookie 中獲取 sessionId
  2. 從 KV 存儲中刪除對應的會話數據
  3. 清除客戶端的會話 cookie
  4. 記錄登出活動日誌
- **成功響應** (200):
  ```json
  {
    "success": true,
    "message": "成功登出"
  }
  ```
- **錯誤響應**:
  - 500: 服務器錯誤

### 用戶管理 API

#### `/api/users` - 用戶創建與查詢
- **方法**: GET（查詢）
- **授權**: 需要管理員權限
- **請求查詢參數**:
  - `active`: 布爾值，篩選活躍用戶
  - `page`: 整數，分頁頁碼
  - `limit`: 整數，每頁項目數
- **處理流程**:
  1. 驗證管理員權限
  2. 解析查詢參數和篩選條件
  3. 從資料庫查詢符合條件的用戶
  4. 整理用戶數據並返回分頁結果
- **成功響應** (200):
  ```json
  {
    "users": [
      {
        "id": "用戶ID",
        "name": "用戶姓名",
        "created_at": 1234567890,
        "is_temporary": false,
        "temporary_expiry": null,
        "is_disabled": false
      }
    ],
    "total": 100,
    "page": 1,
    "limit": 20
  }
  ```
- **錯誤響應**:
  - 401: 未授權
  - 500: 服務器錯誤

- **方法**: POST（創建）
- **授權**: 需要管理員權限
- **請求體**:
  ```json
  {
    "name": "用戶姓名",
    "is_temporary": false,
    "temporary_expiry": 1234567890
  }
  ```
- **處理流程**:
  1. 驗證管理員權限與請求數據
  2. 生成唯一用戶 ID 和 OTP 密鑰
  3. 創建新用戶記錄並存入資料庫
  4. 記錄用戶創建日誌
  5. 返回創建結果和 OTP 設置信息
- **成功響應** (201):
  ```json
  {
    "success": true,
    "user": {
      "id": "生成的用戶ID",
      "name": "用戶姓名",
      "secret": "OTP密鑰",
      "otpauth_url": "otpauth://totp/...",
      "is_temporary": false,
      "temporary_expiry": null
    }
  }
  ```
- **錯誤響應**:
  - 401: 未授權
  - 400: 請求格式錯誤
  - 500: 服務器錯誤

#### `/api/users/:id` - 查詢特定用戶
- **方法**: GET
- **授權**: 需要管理員權限
- **URL 參數**: `id` - 用戶ID
- **處理流程**:
  1. 驗證管理員權限
  2. 從資料庫查詢指定用戶
  3. 檢查用戶是否存在
  4. 返回用戶詳細信息
- **成功響應** (200):
  ```json
  {
    "user": {
      "id": "用戶ID",
      "name": "用戶姓名",
      "created_at": 1234567890,
      "is_temporary": false,
      "temporary_expiry": null,
      "is_disabled": false
    }
  }
  ```
- **錯誤響應**:
  - 401: 未授權
  - 404: 用戶不存在
  - 500: 服務器錯誤

#### `/api/users/:id/toggle-status` - 啟用/禁用用戶
- **方法**: PUT
- **授權**: 需要管理員權限
- **URL 參數**: `id` - 用戶ID
- **請求體**:
  ```json
  {
    "is_disabled": true
  }
  ```
- **處理流程**:
  1. 驗證管理員權限
  2. 查詢目標用戶並檢查是否存在
  3. 更新用戶狀態
  4. 記錄狀態變更日誌
- **成功響應** (200):
  ```json
  {
    "success": true,
    "user": {
      "id": "用戶ID",
      "is_disabled": true
    }
  }
  ```
- **錯誤響應**:
  - 401: 未授權
  - 404: 用戶不存在
  - 400: 請求格式錯誤
  - 500: 服務器錯誤

#### `/api/verify` - 驗證 OTP 令牌
- **方法**: POST
- **請求體**:
  ```json
  {
    "token": "六位OTP驗證碼"
  }
  ```
- **處理流程**:
  1. 驗證請求格式
  2. 從資料庫獲取所有活躍用戶
  3. 遍歷用戶，使用 TOTP 算法驗證每個用戶的密鑰
  4. 找到匹配的用戶後觸發開門操作
  5. 記錄訪問日誌
- **成功響應** (200):
  ```json
  {
    "success": true,
    "message": "驗證成功，門已開啟",
    "user": {
      "name": "用戶姓名",
      "id": "用戶ID"
    }
  }
  ```
- **錯誤響應**:
  - 400: 無效的 OTP 令牌
  - 401: 驗證失敗
  - 500: 服務器錯誤

### 管理員管理 API

#### `/api/admins/current` - 獲取當前管理員信息
- **方法**: GET
- **授權**: 需要管理員權限
- **處理流程**:
  1. 驗證會話有效性
  2. 從會話中獲取管理員信息
  3. 從資料庫查詢完整管理員資料
- **成功響應** (200):
  ```json
  {
    "admin": {
      "id": "管理員ID",
      "username": "管理員用戶名",
      "email": "電子郵件地址",
      "created_at": 1234567890,
      "last_login": 1234567890
    }
  }
  ```
- **錯誤響應**:
  - 401: 未授權
  - 500: 服務器錯誤

#### `/api/admins/username` - 更新管理員使用者名稱
- **方法**: PUT
- **授權**: 需要管理員權限
- **請求體**:
  ```json
  {
    "username": "新用戶名",
    "password": "當前密碼"
  }
  ```
- **處理流程**:
  1. 驗證管理員權限和當前密碼
  2. 驗證新用戶名格式和可用性
  3. 更新資料庫中的管理員用戶名
  4. 記錄變更日誌
- **成功響應** (200):
  ```json
  {
    "success": true,
    "message": "用戶名更新成功"
  }
  ```
- **錯誤響應**:
  - 401: 未授權或密碼錯誤
  - 400: 無效的用戶名格式或用戶名已被使用
  - 500: 服務器錯誤

#### `/api/admins/password` - 更新管理員密碼
- **方法**: PUT
- **授權**: 需要管理員權限
- **請求體**:
  ```json
  {
    "current_password": "當前密碼",
    "new_password": "新密碼",
    "confirm_password": "確認新密碼"
  }
  ```
- **處理流程**:
  1. 驗證管理員權限和當前密碼
  2. 驗證新密碼強度和一致性
  3. 生成新密碼的加密雜湊
  4. 更新資料庫中的密碼雜湊
  5. 記錄密碼變更日誌（不記錄實際密碼）
- **成功響應** (200):
  ```json
  {
    "success": true,
    "message": "密碼更新成功"
  }
  ```
- **錯誤響應**:
  - 401: 未授權或當前密碼錯誤
  - 400: 密碼格式錯誤或確認密碼不匹配
  - 500: 服務器錯誤

#### `/api/admins/email` - 更新管理員郵箱
- **方法**: PUT
- **授權**: 需要管理員權限
- **請求體**:
  ```json
  {
    "email": "new.email@example.com",
    "password": "當前密碼"
  }
  ```
- **處理流程**:
  1. 驗證管理員權限和當前密碼
  2. 驗證新郵箱格式
  3. 更新資料庫中的管理員郵箱
  4. 記錄變更日誌
- **成功響應** (200):
  ```json
  {
    "success": true,
    "message": "郵箱更新成功"
  }
  ```
- **錯誤響應**:
  - 401: 未授權或密碼錯誤
  - 400: 郵箱格式錯誤
  - 500: 服務器錯誤

#### `/api/admins` - 創建與查詢管理員
- **方法**: GET（查詢）
- **授權**: 需要超級管理員權限
- **處理流程**:
  1. 驗證超級管理員權限
  2. 從資料庫查詢管理員列表
  3. 過濾敏感信息（如密碼雜湊）
- **成功響應** (200):
  ```json
  {
    "admins": [
      {
        "id": "管理員ID",
        "username": "管理員用戶名",
        "email": "電子郵件地址",
        "created_at": 1234567890,
        "last_login": 1234567890,
        "is_disabled": false
      }
    ]
  }
  ```
- **錯誤響應**:
  - 401: 未授權
  - 403: 權限不足
  - 500: 服務器錯誤

- **方法**: POST（創建）
- **授權**: 需要超級管理員權限
- **請求體**:
  ```json
  {
    "username": "新管理員用戶名",
    "password": "初始密碼",
    "email": "管理員郵箱"
  }
  ```
- **處理流程**:
  1. 驗證超級管理員權限
  2. 驗證請求數據格式
  3. 檢查用戶名是否已存在
  4. 生成密碼雜湊
  5. 創建新管理員記錄
  6. 記錄創建日誌
- **成功響應** (201):
  ```json
  {
    "success": true,
    "admin": {
      "id": "管理員ID",
      "username": "管理員用戶名",
      "email": "電子郵件地址"
    }
  }
  ```
- **錯誤響應**:
  - 401: 未授權
  - 403: 權限不足
  - 400: 請求格式錯誤或用戶名已存在
  - 500: 服務器錯誤

#### `/api/admins/:id/toggle-status` - 啟用/禁用管理員
- **方法**: PUT
- **授權**: 需要超級管理員權限
- **URL 參數**: `id` - 管理員ID
- **請求體**:
  ```json
  {
    "is_disabled": true
  }
  ```
- **處理流程**:
  1. 驗證超級管理員權限
  2. 查詢目標管理員
  3. 確保不是自己禁用自己
  4. 更新管理員狀態
  5. 記錄操作日誌
- **成功響應** (200):
  ```json
  {
    "success": true,
    "admin": {
      "id": "管理員ID",
      "is_disabled": true
    }
  }
  ```
- **錯誤響應**:
  - 401: 未授權
  - 403: 權限不足或嘗試禁用自己
  - 404: 管理員不存在
  - 500: 服務器錯誤

#### `/api/admins/:id/password` - 管理員密碼重置
- **方法**: PUT
- **授權**: 需要超級管理員權限
- **URL 參數**: `id` - 管理員ID
- **請求體**:
  ```json
  {
    "new_password": "新密碼"
  }
  ```
- **處理流程**:
  1. 驗證超級管理員權限
  2. 查詢目標管理員
  3. 驗證密碼強度
  4. 生成新密碼雜湊並更新
  5. 記錄密碼重置日誌
- **成功響應** (200):
  ```json
  {
    "success": true,
    "message": "密碼重置成功"
  }
  ```
- **錯誤響應**:
  - 401: 未授權
  - 403: 權限不足
  - 404: 管理員不存在
  - 400: 密碼強度不足
  - 500: 服務器錯誤

### 系統 API

#### `/api/logs` - 查詢系統日誌
- **方法**: GET
- **授權**: 需要管理員權限
- **請求查詢參數**:
  - `type`: 日誌類型（user, admin, system）
  - `from`: 時間戳，起始時間
  - `to`: 時間戳，結束時間
  - `user_id`: 用戶ID過濾
  - `page`: 頁碼
  - `limit`: 每頁項目數
- **處理流程**:
  1. 驗證管理員權限
  2. 解析查詢參數
  3. 構建資料庫查詢條件
  4. 獲取分頁日誌數據
  5. 格式化日誌返回結果
- **成功響應** (200):
  ```json
  {
    "logs": [
      {
        "id": "日誌ID",
        "user_id": "用戶ID",
        "user_name": "用戶姓名",
        "action": "執行的動作",
        "timestamp": 1234567890
      }
    ],
    "total": 100,
    "page": 1,
    "limit": 20
  }
  ```
- **錯誤響應**:
  - 401: 未授權
  - 500: 服務器錯誤

#### `/api/status` - 查詢系統狀態
- **方法**: GET
- **授權**: 需要管理員權限
- **處理流程**:
  1. 驗證管理員權限
  2. 收集系統運行數據（啟動時間、用戶數、訪問次數等）
  3. 獲取系統資源使用情況
  4. 匯總統計數據
- **成功響應** (200):
  ```json
  {
    "status": "healthy",
    "uptime": 12345678,
    "start_time": 1234567890,
    "stats": {
      "active_users": 50,
      "total_users": 75,
      "temporary_users": 10,
      "disabled_users": 15,
      "total_accesses": 1250,
      "today_accesses": 42
    },
    "version": "1.2.3"
  }
  ```
- **錯誤響應**:
  - 401: 未授權
  - 500: 服務器錯誤

## 技術實現細節

### 認證流程
1. **管理員認證流程**:
   - 管理員通過登入頁面提供憑據
   - 系統驗證 Turnstile 令牌確保非機器人訪問
   - 服務器端驗證用戶名和密碼（bcrypt 雜湊比對）
   - 創建包含管理員資訊的會話，生成加密的 session ID
   - 將會話資訊存儲在 KV 儲存中，設置過期時間
   - 向客戶端返回 HTTP-only cookies 以維持會話狀態
   - 後續請求通過 authMiddleware 驗證會話有效性，檢查會話是否過期

2. **會話管理機制**:
   - 會話 ID 格式: `{時間戳}-{隨機UUID}`
   - 會話存儲結構: `session:{sessionId} = {username, email, created_at, expires_at, last_activity}`
   - 閒置超時: 30分鐘無活動自動失效
   - 絕對過期: 無論活動情況，會話最長壽命為 24 小時
   - 會話續期: 活動時自動延長閒置超時，但不超過絕對過期時間

### OTP 驗證流程
1. **密鑰生成與管理**:
   - 為每個用戶生成 32 位隨機 Base32 密鑰
   - 密鑰安全存儲於資料庫，不可從前端查看
   - 用戶創建時生成 QR 碼供掃描添加至認證器應用

2. **驗證過程**:
   - 用戶從其 TOTP 應用程式（如 Google Authenticator）獲取六位數一次性密碼
   - 通過 `/api/verify` 端點提交密碼
   - 系統遍歷所有未禁用的、非過期用戶，使用 TOTP 算法檢查密碼是否匹配
   - TOTP 驗證時使用 30 秒時間窗口，允許 ±1 窗口的時間偏移以處理時鐘不同步情況
   - 成功匹配後觸發開門操作，並記錄訪問日誌（包含用戶資訊和時間戳）
   - 連續失敗的驗證嘗試會被記錄以防止暴力破解攻擊

3. **臨時用戶處理**:
   - 系統自動檢查臨時用戶的過期時間
   - 過期的臨時用戶密鑰自動失效，不再參與驗證過程
   - 可選配置: 過期用戶自動禁用或定期清理

### 門禁控制機制
1. **開門流程**:
   - 成功驗證 OTP 後，系統向指定的硬件控制器發送加密指令
   - 支持多種硬件通信協議（HTTP API、串口通信等）
   - 指令包含數字簽名，硬件端驗證以確保來源可靠
   - 設置開門持續時間（預設 5 秒）
   - 實現請求限流，防止短時間內的重複請求（冷卻時間 30 秒）

2. **安全保護措施**:
   - 硬件通信使用 HTTPS 加密或專有加密協議
   - 開門請求帶有時間戳，防止重放攻擊
   - 系統記錄所有開門事件，包括失敗嘗試
   - 異常行為檢測：連續失敗的開門嘗試會觸發警報
   - 支持緊急模式：特定條件下可暫時解除訪問限制

### 安全機制
- **密碼安全**:
  - 密碼使用 bcrypt（成本因子 12）進行雜湊處理，不以明文存儲
  - 密碼策略強制執行：最少 8 字符，必須包含大小寫字母、數字和特殊字符
  - 定期提醒更改密碼，防止長期使用相同密碼

- **TOTP 安全**:
  - TOTP 提供基於時間的一次性密碼，有效期僅 30 秒
  - 每位用戶專屬密鑰，每次生成的令牌互不相關
  - 支持時間偏移處理，但仍有嚴格的時間有效性限制

- **會話安全**:
  - 使用 HTTP-only cookies 防止 JavaScript 訪問會話數據
  - 實施嚴格的 CORS 和 CSP 策略，防止跨站攻擊
  - 會話有效期限制，定期要求重新認證
  - 自動檢測異常登入行為（不尋常的 IP 地址或設備變更）

- **攻擊防護**:
  - Turnstile 集成防止自動化攻擊和暴力破解
  - 實施請求頻率限制，防止 DoS 攻擊
  - API 端點權限嚴格控制，遵循最小權限原則
  - 針對敏感操作實施二次確認機制

## 部署說明

系統基於 Cloudflare Workers 平台，部署過程需要：

1. **環境準備**:
   - 註冊 Cloudflare 帳戶並啟用 Workers
   - 安裝 Wrangler CLI 工具: `npm install -g wrangler`
   - 執行 `wrangler login` 進行身份驗證

2. **資源設置**:
   - 在 Cloudflare 控制面板中建立 D1 數據庫
   - 建立 KV 命名空間用於會話管理
   - 配置 Turnstile 以獲取站點密鑰和密鑰

3. **配置修改**:
   - 編輯 `wrangler.toml` 文件設置資源綁定:
     ```toml
     [[d1_databases]]
     binding = "DB"
     database_name = "your-database-name"
     database_id = "your-database-id"

     [[kv_namespaces]]
     binding = "HOME_OTP"
     id = "your-kv-namespace-id"
     ```
   - 設置環境變量和綁定（可通過 `wrangler.toml` 或 Dashboard）:
     - `DB`: D1 數據庫綁定
     - `HOME_OTP`: KV 儲存綁定
     - `ASSETS`: Worker 靜態資源綁定
     - `TURNSTILE_SITE_KEY`: Cloudflare Turnstile 站點密鑰
     - `TURNSTILE_SECRET_KEY`: Cloudflare Turnstile 密鑰
     - `DOOR_API_ENDPOINT`: 門禁控制器 API 地址
     - `DOOR_API_KEY`: 門禁控制器 API 密鑰

4. **部署步驟**:
   - 本地開發和測試: `wrangler dev`
   - 資料庫遷移: `wrangler d1 execute your-database-name --file=./schema.sql`
   - 發佈至生產環境: `wrangler deploy`

5. **部署後設置**:
   - 首次訪問系統時，會自動初始化資料庫結構
   - 使用預設管理員賬戶登錄（首次登入後務必修改密碼）
   - 配置系統設置，添加首批用戶

6. **定期維護**:
   - 備份 D1 數據庫: `wrangler d1 backup your-database-name`
   - 監控系統日誌和訪問記錄
   - 定期檢查臨時用戶過期情況